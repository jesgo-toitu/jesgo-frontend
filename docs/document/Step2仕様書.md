<style>
BODY {
    font-family: 'BIZ UDPMincho', serif;
}
</style>
# 婦人科悪性腫瘍総合入力システム<br/>JESGO(Japan entry system of gynecologic oncology)<br/>Step2

<table style="margin-top: 5rem; margin-left: auto; margin-right: auto;">
<tr><td>proof</td><td>2022-10-06 山本(P4mohnet)</td></tr>
</table>

## 1.JESGO Step2について
JESGO Step2では、step1で実装されたドキュメントの作成機能に対して、以下の機能を付与する。

- ドキュメントからの情報抽出
  - 抽出された情報に対する検証
  - 抽出された情報の整形
  - 抽出された情報の出力
- 与えられた情報によるドキュメントの操作
  - 外部からの情報入力によるドキュメントの新規作成、ドキュメント内項目の設定
  - ドキュメントから抽出された情報によるドキュメントの新規作成、ドキュメント内項目の設定

## 2.セキュリティに関する事項
スクリプトはシステム側が用意する者の他、ユーザが独自に作成、システムに登録することが可能である。
スクリプトの実行に関しては、ユーザ権限により以下の制限が掛けられることが望ましい。

- スクリプトのシステムへの導入、削除、実行が可能
- 全てのスクリプトの実行が可能
- ドキュメントからの情報抽出のみ実施可能
- ドキュメントからの情報抽出ならびにその抽出情報に基づいたドキュメント内項目の設定が可能
- スクリプトの実行不許可

ドキュメントの新規作成やドキュメント内項目の設定がある場合は、逐次ユーザに対してその内容の確認を行う。ただし、ユーザの許可によりセッション内においては個別の確認を省略することができる。

## 3.スクリプトが対象とするドキュメント
スクリプトが対象とするドキュメントは以下の単位を想定する。

- データベースが保持する全ての患者レコードから年次などで抽出された患者レコードと患者の保有するドキュメント全体
- データベースが保持する全ての患者レコードからスクリプトの要求する条件で抽出された患者レコードと患者の保有するドキュメント全体
- データベースが保持する全ての患者レコードからスクリプトの要求する条件で抽出された個別のドキュメントとそこから連なる一連のドキュメント

上記はデータベース全体を参照するので患者リスト画面から実行する。スクリプトからの抽出要求が無い場合は、ユーザに対して患者リスト画面での抽出作業を要求する。

- 各患者の患者レコードと保有するドキュメント全体

上記は患者編集画面から患者個別に実行する。

- 指定したドキュメントに連なる一連のドキュメント

上記はスクリプトの要求するドキュメント(ドキュメントidで管理)が開かれているときにドキュメントメニューから実行する。

## 4.スクリプトの管理
スクリプトの導入と削除は、その権限を持つユーザによって行われる。

スクリプトは、バックエンドのデータベース内に保存され、その実行はフロントエンドで行われる。
バックエンドのデータベースには、スクリプトの名称、スクリプトのバージョン、スクリプトが要求するドキュメントの種別やid、ならびにスクリプト本体が保存される。
基本的に、同じスクリプトの名称が同じ場合はバージョンの新しいもので上書きされる。ただし、古いバージョンのもので上書きすることも許容される。

## 5.スクリプトの仕様
単一ファイルのJavaScriptモジュールとして作成され、データベースに内容が保存される。データベースには、スクリプトが対象とするドキュメント単位も保存される。
フロントエンドから、モジュールをダイナミックインポートし、モジュール中の公開メソッド init() を実行して動作に必要な情報を取得する。システムの動作を速やかにするため、スクリプトをシステムにインポートする際にこの情報が取得されデータベースにキャッシュされる。

スクリプトの動作中、データベースへのアクセスは単一のトランザクションに分離され、書き戻しについてユーザの確認と最終許可の元で実施される。

### 5.1. スクリプトの公開メソッド init()
必須の非同期関数で、スクリプト内部の初期化および返り値としてスクリプトの動作に関する情報をもつオブジェクトを返す。スクリプト導入の際のみならず、実行の際にも必ず実行される。

返り値として以下の内容を最低限保持するものとする。
- スクリプトの名称
- スクリプトのバージョン
- スクリプトの要求するドキュメント(jsonpathもしくはスキーマのid)
- スクリプトがデータベースへの書き戻しを行うか否か(デフォルトでは書き戻しを行わない)

### 5.2. スクリプトの公開メソッド main()
必須の非同期関数。実際の動作を行う。第一引数として指定されたドキュメントオブジェクト、第二引数として情報書き戻しなどを行うフロントエンド関数を渡す。
異常終了した際には例外を発生させ終了する。

フロントエンド側で実行されるため、ユーザからの入力をうけつける window.alert, window.confirm, window.prompt などのメソッドの利用が可能である。

実行にあたってはロックアウトを回避する為、最長の実行時間が15分程度となるように制限を設ける。この時間についてはシステム側で設定、保存可能とする。

### 5.3. スクリプトの公開メソッド finally()
スクリプトの終了処理を行う非同期関数。必須ではない。

### 5.4. 情報を表示・保存するフロントエンド関数
第一引数としてplain textを受け取り、それを表示する。改行やスペースはそのまま維持し、セキュリティ面からHTMLテキストは許容しない。
第二引数にテキストデータが与えられた場合は、utf8文字列（改行コードは任意）としてその情報をファイルに保存するコントロールを表示する。

### 5.5. 書き戻しを行うフロントエンド関数
引数として、ドキュメントの書き換えに関するタプルを受け取る。タプルの項目はkey valueの形式のオブジェクトとする。

新規にドキュメントを作成することはないが、以下のパターンに対応する。

- 症例番号もしくはハッシュ値で指定された患者の全ドキュメント中jsonpathに該当する項目を設定する
- 症例番号もしくはハッシュ値で指定された患者の指定されたidのスキーマで用意されたドキュメントの、指定項目を設定する
- 現在利用している患者のドキュメント中のjsonpathに該当する項目を設定する
- 現在利用している患者の指定されたidのスキーマで用意されたドキュメントの、指定項目を設定する
- 現在利用しているドキュメントのjsonpathに該当もしくは指定国目を設定する

書き戻しの内容については、逐次ユーザに確認を求める。特に既に存在する情報の上書きには内容の確認を要求する。

### 5.6. テーブルを表示するフロントエンド関数
スクリプトの返り値としてCSVを代表とするテーブル構造のデータである場合、ユーザの便宜のため、別ウインドウでその返り値をテーブルとして表示、CSVやJSON形式で保存可能とする。

引数としてタプルを受け取り、タプルの項目はオブジェクトとする。横にオブジェクトのkey(順番を可能な限り維持)として縦軸にタプルの順に成形して表示する。
JSONで出力する際は、そのタプルをそのままJSON形式として出力する。CSVで出力する場合は、表の通りに出力する。可能な限り、数値であるか文字列であるかは維持する。

### 6. 患者を特定するハッシュ値の生成について
患者情報全体を取得するドキュメントには、患者のID、生年月日から生成されたハッシュ値を添付する。このハッシュ値は患者データとあわせて保存されず、逐次問い合わせに対して演算して算出する。
可搬性を考慮しsha-256でのハッシュ値作成(digest)を標準とする。

## 7.スクリプトの実装に関わる問題点
ダイナミックインポートを用いることでモダンブラウザのもつXSS警告を回避することが可能となり、スクリプト側の自由度が十分に担保される。
一方で、ユーザには操作により情報漏洩に繋がりうるということを周知する必要がある。
