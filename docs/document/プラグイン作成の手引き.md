# プラグイン作成の手引き
このドキュメントではJESGOで使用するプラグイン作成時に必要な知識、作成方法について記述します。

## 用語説明
- オブジェクト: JavaScriptで`{ name: "テスト", age: 25 }`のように定義されるkey/value形式のデータ

## 1. プラグインとは
- プラグインはJESGO内のドキュメントを出力・加工・更新する機能を、システム更新せずに実現できる拡張機能です
- プラグインはJavaScriptで記述します
- プラグイン管理画面からJavaScriptを登録して使用することができます
- プラグインの文字コードは**UTF-8**で作成してください

## 2. プラグインでできること
- 症例登録の各種ドキュメント内容出力
- 症例登録の各種ドキュメント内容更新
  - 更新の元になるデータとしてCSVなどの外部ファイルの読み込みも可
- その他JavaScriptで実現できる機能の実装

## 3. プラグインの構成と公開関数
- プラグインにはいくつか必須の関数を定義する必要があります
- 必須の関数は非同期関数(async)にし、`export`で公開する必要があります

### 3.1. init() ★必須
- 引数: なし
- 戻値: プラグインの基本情報のオブジェクト

#### 詳細
プラグイン登録時などに呼び出し、どのような振る舞いをするプラグインなのかを取得します。  
設定値の詳細は**4. initの設定によるプラグインの振る舞い**をご覧ください

### 3.2. main(param1, param2) ★必須
- 引数
  - 第1引数: ドキュメントデータのオブジェクトなど。initの設定により変わる
  - 第2引数: フロントエンドで定義した関数。データ書き戻し時のAPI実行など実施
- 戻値: array、もしくは文字列データなど

#### 詳細
プラグイン実行時のメインとなる処理を記述する関数です。
第1引数に渡されたドキュメントデータなどを加工して返したり、エラーチェックなどを行うこともできます。
第2引数にはAPIの実行などがラップされた関数が渡されるため、加工したデータを関数に渡してドキュメントの更新が行えます。

### 3.3. finalize() 任意
- 引数: なし
- 戻値: なし

#### 詳細
mainの処理が完了後に呼ばれる関数です。必須ではないため、なくても動作します。

### 最小構成でのスクリプト記述例
**output_all.js**
```js
export async function init() {
    return {
        plugin_name: '全患者全文書出力',
        plugin_version: '1.0',
        all_patient: true,
        update_db: false,
        target_schema_id_string: '',
        attach_patient_info: true,
        show_upload_dialog: false,
        filter_schema_query: '',
        explain: '全患者のドキュメントをJSONで出力します',
    };
}
export async function main(docObj, func) {
    const returnSchemaApiObject = await func(docObj);
    return JSON.parse(returnSchemaApiObject);
}
```

## 4. initの設定によるプラグインの振る舞い
initで返す設定内容に応じてプラグインの挙動が変わります。

### 4.1. init設定値

| 項目名                  | 型      | 説明                                                         |
| ----------------------- | ------- | ------------------------------------------------------------ |
| plugin_name             | string  | プラグイン名                                                 |
| plugin_version          | string  | バージョン番号(1.0など)                                      |
| target_schema_id_string | string  | 対象のスキーマID(パス)                                       |
| all_patient             | boolean | 全患者対象のプラグインか否か                                 |
| update_db               | boolean | DBへの更新を行うプラグインか否か                             |
| attach_patient_info     | boolean | 出力するドキュメントに患者氏名などの個人情報を載せるか否か   |
| show_upload_dialog      | boolean | ファイルアップロードが必要か否か                             |
| filter_schema_query     | string  | 出力対象のスキーマをフィルターするクエリ(jsonpath)           |
| explain                 | string  | プラグインの説明文                                           |

#### all_patient
- true: 患者リスト画面のプラグイン選択メニューに配置されます。**すべての患者を対象とするプラグイン**の場合に設定します。
- false: 症例登録画面のヘッダ、もしくは**target_schema_id_string**が指定されている場合は対象スキーマドキュメントのメニューに配置されます。
  **患者単体を対象とするプラグイン**の場合に設定します。

#### update_db
- true: データを更新するプラグインに設定します
- false: データを出力するプラグインに設定します

#### attach_patient_info
データ出力プラグイン(update_db=false)の場合に有効
- true: 個人情報(患者ID、氏名、生年月日、死亡日、性別)も出力します
- false: 個人情報を出力しません

#### show_upload_dialog
データ更新プラグイン(update_db=true)の場合に有効
- true: ファイルアップロードダイアログを表示します。ファイルの内容はmainの第1引数に渡されます
- false: ファイルアップロードダイアログを表示しません。mainの第1引数には各患者のドキュメント情報が渡されます

#### target_schema_id_string
処理対象のスキーマID(/schema/CC/rootなど)を指定。未指定の場合は全スキーマが対象となります。
データ更新時に渡されるドキュメントデータも対象のスキーマのみに限定できます。
スキーマIDは`*`を使用するとワイルドカードによる指定ができ、複数のスキーマを対象とすることができます。
例）target_schema_id_string: "/schema/*/root"
この場合、"/schema/CC/root", "/schema/EM/root", "/schema/OV/root", "schema/common/root"のスキーマが対象になります。

#### filter_schema_query
データ出力プラグイン(update_db=false)の場合に有効
出力対象のドキュメントをjsonpathを使用してフィルターします。
予めフィルターすることで処理の負荷軽減が行えます。
**診断日が2022/01/01以降のドキュメントで抽出する例）**
filter_schema_query: '$.診断日 >= "2022-01-01"'

## 5. データ出力プラグイン作成方法
### 5.1. initの構成例
例）全患者全文書出力
- データ出力系プラグイン
- 全患者対象のため、患者リスト画面から実行する
```js
export async function init() {
    return {
        plugin_name: '全患者全文書出力',
        plugin_version: '1.0',
        all_patient: true,
        update_db: false,
        target_schema_id_string: '',
        attach_patient_info: true,
        show_upload_dialog: false,
        filter_schema_query: '',
        explain: '全患者のドキュメントをJSONで出力します',
    };
}
```

### 5.2. mainの処理
main関数を作成し、第1引数の患者情報を第2引数の関数に渡すと対象患者のドキュメントが取得できます。

**記述例**
```js
export async function main(caseObj, func) {

    const documentList = await func(caseObj);
    
    return JSON.parse(documentList);
}
```

#### 第1引数のデータ
データ出力プラグインの第1引数には以下のように対象の患者情報の一覧がarrayで渡されます。  
**通常、このデータを加工することはありません。**
```js
{
  caseList: [
    {
      case_id: 1,
      name: "テスト1",
      date_of_birth: "1900-01-01",
      date_of_death: "1900-01-01",
      sex: "F",
      his_id: "111",
      decline: false,
      registrant: -1,
      last_updated: "1900-01-01",
      is_new_case: false
    },
    {
      case_id: 2,
      name: "テスト2",
      date_of_birth: "1900-01-01",
      date_of_death: "1900-01-01",
      sex: "F",
      his_id: "222",
      decline: false,
      registrant: -1,
      last_updated: "1900-01-01",
      is_new_case: false
    }
  ],
  filterQuery: ""
}
```

#### 第2引数の関数
mainの第2引数には非同期関数が渡されており、mainの第1引数に渡された患者情報をこの関数の引数に渡すと
患者情報に基づいた一連のドキュメントがJSON形式で取得できます。

- 患者ごとにarrayへ格納されます
- attach_patient_info=falseの場合、his_id(患者ID)、name(氏名)、date_of_birth(生年月日)は載りません
- documentListに対象患者のドキュメントがセットされます。`"スキーマ名": { ドキュメントの内容 }`で表現されます
- サブスキーマ、子スキーマのドキュメントはオブジェクトの入れ子で表現されます

**取得できるJSONの例**
```json
[
  {
    "hash": "92eb4969391b0275b49a08930670067807cbfb1dca9054c08d18c433e2164f0c",
    "decline": false,
    "his_id": "111",
    "date_of_birth": "2009-08-21",
    "name": "テスト1",
    "documentList": [
      {
        "患者台帳": {
          "がん種": "子宮頸がん",
          "診断日": "2023-11-28",
          "腫瘍登録対象": "いいえ",
          "初回治療開始日": "2023-09-22",
          "jesgo:document_id": 9,
          "jesgo:schema_id": "/schema/CC/root",
          "病期診断": {
            "cTNM": {
              "M": {},
              "N": {},
              "T": {}
            },
            "ypTNM": {
              "M": {},
              "N": {},
              "T": {}
            },
            "治療施行状況": "術前治療後に手術施行",
            "jesgo:document_id": 1,
            "jesgo:schema_id": "/schema/CC/staging"
          }
        }
      }
   ]
 },
 {
    "hash": "2f429ccf1169c3bdd028c9a074eed29086b90fd93e4c272aeeddbe92d98e5b69",
    "decline": false,
    "his_id": "222",
    "date_of_birth": "2000-06-25",
    "name": "テスト2",
    "documentList": [
    ～(省略)～
    ]
  }
]
```

**JSON定義**

| 項目名            | 型       | 説明                                                                           |
| ----------------- | -------- | ------------------------------------------------------------------------------ |
| hash              | string   | 患者を特定するハッシュ値                                                       |
| decline           | boolean  | 患者情報: 登録拒否                                                             |
| his_id            | string   | 患者情報: 患者ID                                                               |
| date_of_birth     | string   | 患者情報: 生年月日                                                             |
| name              | string   | 患者情報: 氏名                                                                 |
| documentList      | object[] | 患者に連なるドキュメント一覧                                                   |
| jesgo:document_id | number   | documentList内のドキュメントオブジェクトに付与。ドキュメントを識別する一意なID |
| jesgo:schema_id   | string   | documentList内のドキュメントオブジェクトに付与。ドキュメントのスキーマID(パス) |

#### mainの戻値
main関数にてreturnで返した値は別途画面が開き、画面上に表示されます。
返す値によって出力結果の表現方法が異なります。

- 文字列: 画面にそのまま表示します
- オブジェクト: JSON.stringifyにて整形し、画面に表示します
- 多次元配列: ヘッダ付きのテーブル形式で表示します。データダウンロード時はCSV形式となります
※多次元配列とは以下のように入れ子になったarray。1行目はヘッダとして扱う
```js
[
    ["No", "氏名"],
    ["1" , "太郎"],
    ["2" , "次郎"]
]
```

CSV形式で出力したい場合、多次元配列を利用します。
ドキュメントデータをスクリプトで抽出・加工することでドキュメントをCSVに変換するなども可能です。

## 6. データ更新プラグイン
### 6.1. initの構成例
例）初回治療開始日セット
- データ更新系プラグイン
- 初回治療開始日は各がん種のルートにあるため、ドキュメントのメニューから実行する
- ファイルアップロードは行わず、ドキュメントデータを使用する
```js
export async function init() {
    return {
        plugin_name: '初回治療開始日セット',
        plugin_version: '1.0',
        all_patient: false, // 患者ごとに実行したいためfalse
        update_db: true, // データ更新あり
        target_schema_id_string: '/schema/*/root', // *で複数スキーマ指定
        attach_patient_info: false,
        show_upload_dialog: false, // アップロード不要
        filter_schema_query: '',
        explain: '初回治療開始日に現在日をセットするプラグイン',
    };
}
```

### 6.2. mainの処理
main関数を作成します。第1引数に渡されるデータはファイルアップロードありかなしで変わります。

**記述例**
```js
export async function main(documentList, func) {
    const updateList = []; // 更新用オブジェクトのarray
    if(documentList && documentList.length > 0) {
      const targetDoc = documentList[0];
      const today = new Date();
      updateList.push({
        document_id: targetDoc.document_id,
        target: {
          "/初回治療開始日": `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`
        }
      });

      // 更新用オブジェクトをAPIに渡して更新処理実行
      await func(updateList);
    }
}
```

#### 第1引数のデータ
##### ・ファイルアップロードあり(show_upload_dialog=true)の場合

第1引数にはアップロードされたファイルの内容がテキスト(UTF-8)で渡されます。  
アップロードするファイルの種類に制限はありませんが、CSVファイルなどを想定しています。

##### ・ファイルアップロードなし(show_upload_dialog=false)の場合

ドキュメントデータがオブジェクトのarrayで渡されます。

**ドキュメントデータの例**
```js
[
  {
    document_id: 9,
    case_id: 1,
    schema_id: "/schema/CC/root",
    hash: "92eb4969391b0275b49a08930670067807cbfb1dca9054c08d18c433e2164f0c",
    document: {
      がん種: "子宮頸がん",
      診断日: "2023-11-28",
      腫瘍登録対象: "いいえ",
      初回治療開始日: "2023-12-21"
    }
  }
]
```

**オブジェクト定義**
| 項目名      | 型      | 説明                                    |
| ------------| ------- | --------------------------------------- |
| document_id | string  | ドキュメントを識別する一意なID          |
| case_id     | number  | 患者を識別する一意なID(患者IDではない)  |
| schema_id   | string  | ドキュメントのスキーマID(パス)          |
| hash        | string  | 患者を特定するハッシュ値                |
| document    | object  | ドキュメントの内容                      |

渡されるドキュメントデータは呼び出し場所、スキーマ指定の有無で変わります
- 患者リストから実行: 全患者のドキュメントが対象
  - target_schema_id_stringの指定なし: 全てのスキーマのドキュメントが対象
  - target_schema_id_stringの指定あり: 指定したスキーマのドキュメントが対象
- 症例登録(ヘッダ)から実行: 対象患者の全ドキュメントが対象
- 症例登録(ドキュメントメニュー)から実行: 対象のドキュメントが対象

#### 第2引数の関数
mainの第2引数には非同期関数が渡されており、この関数に**更新用オブジェクトのarray**を渡すと
ドキュメントの内容を更新することができます。

### 6.3. 更新用オブジェクトとその構成
更新用オブジェクトは、どの患者のどのスキーマ(ドキュメント)のどの項目を更新するのか指示を与えるものです。
1つのスキーマ(ドキュメント)に対し1つのオブジェクトを生成します。  

以下のような構成になっています。

**更新用オブジェクトの記述例**  
```js
{
  document_id: 10,
  case_id: 1,
  hash: "92eb4969391b0275b49a08930670067807cbfb1dca9054c08d18c433e2164f0c",
  case_no: "CC2023-10",
  schema_id: "/schema/CC/root",
  target: {
    "/初回治療開始日": "2023-12-01",
    "/診断日": "2023-11-10"
  }
}
```

**オブジェクト定義**  
| 項目名      | 型      | 説明                                    |
| ------------| ------- | --------------------------------------- |
| document_id | string  | ドキュメントを識別する一意なID          |
| case_id     | number  | 患者を識別する一意なID(患者IDではない)  |
| hash        | string  | 患者を特定するハッシュ値                |
| case_no     | string  | 患者の腫瘍登録番号                      |
| schema_id   | string  | 対象のスキーマID(パス)                  |
| target      | object  | 更新対象の項目(JSONPointer)と値のセット |

- document_idがある場合、対象のドキュメントに対して更新します。case_id、hash、case_noなどの指定は不要です。
- case_id、hash、case_noは患者を特定するための情報です。いずれか1つあれば更新可能です。schema_idと組み合わせて使用します。
- targetに更新対象の項目を記述します。詳細は以下の**targetについて**をご覧ください

#### 制限事項
- schema_idの指定がある場合、initのtarget_schema_id_stringに同じIDの設定が必要です。
- ドキュメントのメニューから実行する場合、対象ドキュメント以外に対する更新はできません

#### targetについて
targetには更新対象の項目のJSONPointer表記と更新する値の組み合わせをオブジェクトを用いて表現します。  
以下の例では初回治療開始日に`2023-12-01`、診断日に`2023-11-10`をセットします。

```js
target: {
    "/初回治療開始日": "2023-12-01",
    "/診断日": "2023-11-10"
  }
```

JSONPointerを用いることで入れ子になったオブジェクトやarrayに対しての更新も行えます。

```js
// 入れ子になったオブジェクトの更新
target: {
  "/予後調査/3年": "2023-12-20"
}

// arrayの最初の要素のオブジェクトの更新
target: {
  "/実施手術/0/術式": "広汎子宮全摘出術"
}

// arrayそのものの更新
target: {
  "/実施手術": [ { "術式": "広汎子宮全摘出術" }, { "術式": "準広汎子宮頸部摘出術" } ]
}
```